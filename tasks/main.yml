---
  - name: Gathering OS Family facts
    setup: filter='ansible_os_family'
    #setup: filter='*'
    tags: common

  - name: include profiles config
    include: profiles.yml
    tags: common

#  - name: include iptables task
#    include: iptables.yml
#    tags: ["common", "iptables"]

  - name: include ssh task
    include: ssh.yml
    tags: common, ssh

  - name: Set timezone to Europe/Moscow
    timezone:
      name: Europe/Moscow
    tags: common

  - name: Set NTP server
    lineinfile:
      dest: /etc/systemd/timesyncd.conf
      state: present
      regexp: '^NTP'
      line: NTP={{ ntpserver }}
    notify:
      - Reload systemd-timesyncd
    when: ntpserver != "default"
    tags: ntp

  - name: Set hostname
    hostname:
      name: "{{ item }}"
    with_items:
      - "{{ ansible_hostname }}"
    tags: hostname

  # Install packages
  - name: include Debian tasks
    include: debian.yml
    when: (ansible_os_family == "Debian")
    tags: common

  - name: include RedHat tasks
    include: redhat.yml
    when: (ansible_os_family == "RedHat")
    tags: common

  - name: installing common packages
    package:
      pkg: "{{ item }}"
      update_cache: yes
    with_items:
      - "{{ packages }}"
    tags: common, packages

  - name: installing additional packages
    package:
      pkg: "{{ item }}"
      update_cache: yes
    with_items:
      - "{{ additional_packages | default([]) }}"
    tags: common, packages
